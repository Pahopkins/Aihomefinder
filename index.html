<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AI Home Search – homesforsaleflorida.kw.com</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --green:#059669; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; color: var(--ink); background:#f8fafc; }
    .wrap { max-width: 1100px; margin: 20px auto; padding: 0 16px; }
    .card { background:#fff; border:1px solid var(--line); border-radius:14px; padding:16px; }
    h1 { font-size:20px; margin:0 0 6px; }
    .hint { font-size:13px; color: var(--muted); margin-bottom:10px; }
    textarea { width:100%; min-height:76px; border:1px solid #cbd5e1; border-radius:12px; padding:12px 14px; font-size:14px; resize:vertical; outline:none; }
    textarea:focus { border-color: var(--green); box-shadow: 0 0 0 3px rgba(5,150,105,.2); }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:10px; }
    .btn { border:0; background: var(--green); color:#fff; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; }
    .btn.secondary { background:#0ea5e9; }
    .meta { font-size:12px; color: var(--muted); }
    .kvgrid { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:6px 14px; margin-top:10px; }
    .kv { font-size:13px; }
    .kv .lab { color: var(--muted); margin-right:6px; }
    .links { display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
    .alink { display:inline-flex; align-items:center; gap:6px; padding:8px 12px; border:1px solid var(--green); color: var(--green); border-radius:10px; text-decoration:none; font-weight:700; }
    .alink.secondary { border-color:#0ea5e9; color:#0ea5e9; }
    .ex { margin-top:8px; font-size:12px; background:#ecfdf5; border:1px dashed #34d399; color:#065f46; padding:10px 12px; border-radius:10px; }
    .results { margin-top:16px; }
    .frameWrap { border:1px solid var(--line); border-radius:14px; overflow:hidden; background:#fff; }
    iframe { width:100%; height:90vh; border:0; } /* Taller frame */
    .notice { padding:12px; color:#b45309; background:#fffbeb; border:1px solid #fde68a; border-radius:10px; font-size:13px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>AI Home Search → homesforsaleflorida.kw.com</h1>
      <div class="hint">Describe your ideal home (e.g., “Port St Lucie under $650k, 4 bed, 2 bath, pool, garage, built after 2005”).</div>
      <textarea id="q" placeholder="Type your search…"></textarea>
      <div class="row">
        <button class="btn" id="go">Search</button>
        <button class="btn secondary" id="open">Open in New Tab</button>
        <div class="meta" id="status"></div>
      </div>
      <div class="ex">Examples: “Port Charlotte 4 bed with pool under 650k” • “Jupiter FL 4 bed 3 bath 800–950k 2000+ sqft new construction good schools townhouse”.</div>

      <div id="summary" class="results"></div>

      <div class="results">
        <div id="frameNotice" class="notice" style="display:none;">
          We tried to load the KW results inside this page, but the site prevented framing (X-Frame-Options / CSP).
          Use <strong>Open in New Tab</strong> instead.
        </div>
        <div class="frameWrap" id="frameWrap" style="display:none;">
          <iframe id="resultsFrame" title="KW Search Results"></iframe>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // ===== Target site =====
  const KW = { domain: "https://homesforsaleflorida.kw.com", path: "/search/sale" };

  // ===== DOM =====
  const $ = sel => document.querySelector(sel);
  const elQ = $('#q'), elGo = $('#go'), elOpen = $('#open'), elStatus = $('#status');
  const elSummary = $('#summary'), elFrame = $('#resultsFrame'), elFrameWrap = $('#frameWrap'), elFrameNotice = $('#frameNotice');

  // ===== Utilities =====
  function normalizeMoney(raw){
    if(!raw) return null;
    let t = String(raw).toLowerCase().replace(/[, \$]/g,'').trim();
    const mult = { k:1e3, m:1e6, b:1e9 };
    const m = t.match(/^(\d+(?:\.\d+)?)([kmb])?$/);
    if(!m) return parseInt(t,10) || null;
    return Math.round(parseFloat(m[1]) * (m[2] ? mult[m[2]] : 1));
  }
  function sqftToNumber(raw){ const m = String(raw).match(/(\d{3,6})/); return m ? Number(m[1]) : null; }
  function acresToNumber(raw){ const m = String(raw).match(/(\d+(?:\.\d+)?)/); return m ? Number(m[1]) : null; }

  // KW expects snake_case keyword tokens; normalise everything
  function normalizeKeywordToken(t) {
    return String(t)
      .trim()
      .toLowerCase()
      .replace(/[\s\-]+/g, "_")     // spaces/dashes → underscore
      .replace(/[^a-z0-9_]/g, "");  // strip punctuation
  }

  // Property subtype detection
  const SUBTYPE = [
    { rx:/\b(condo|minium)\b/i, val:"CONDO" },
    { rx:/\b(town(?:home|house))\b/i, val:"TOWNHOUSE" },
    { rx:/\b(villa)\b/i, val:"VILLA" },
    { rx:/\b(mobile|manufactured)\b/i, val:"MOBILE" },
    { rx:/\b(multifamily|duplex|triplex|quadplex)\b/i, val:"MULTI_FAMILY" }
  ];
  function detectSubtype(s){ for(const t of SUBTYPE){ if(t.rx.test(s)) return t.val; } return "HOUSE"; }

  // Robust feature recognisers (incl. screened/heated/saltwater/inground pools)
  const FEATURE_RX = {
    pool: /\b(pool|swimming\s*pool|screened\s*pool|heated\s*pool|salt[-\s]*water\s*pool|in[-\s]*ground\s*pool|inground\s*pool|private\s*pool|community\s*pool)\b/i,
    "fenced yard": /\b(fenced|fence|privacy\s*fence|fenced[-\s]*yard)\b/i,
    garage: /\b(garage|[23]\s*car\s*garage|attached\s*garage|detached\s*garage|parking)\b/i,
    parking: /\b(parking|driveway|carport)\b/i,
    "new construction": /\b(new\s*construction|newly\s*built|brand\s*new|never\s*lived\s*in)\b/i,
    "kitchen island": /\b(kitchen.*island|island.*kitchen|breakfast\s*bar)\b/i,
    "good school district": /\b(a[-\s]?rated|good|top|excellent)\s+school(s)?|school\s+district|school\s+zone\b/i,
    "hot tub": /\b(hot\s*tub|spa|jacuzzi)\b/i
  };

  // Map labels → KW keyword tokens (snake_case)
  const FEATURE_TO_KEYWORDS = {
    pool: ["pool"],
    "fenced yard": ["fenced_yard","fence"],
    garage: ["garage","parking"],
    parking: ["parking"],
    "new construction": ["new_construction","newly_built","brand_new"],
    "kitchen island": ["kitchen_island","breakfast_bar"],
    "good school district": ["good_schools","a_rated_schools","school_district","school_zone"],
    "hot tub": ["hot_tub","spa","jacuzzi"]
  };

  // Florida city hints + aliases (PSL etc.)
  const CITY_HINTS = [
    { rx:/\bpsl\b|\bport\s*st\.?\s*lucie\b/i, norm:"Port Saint Lucie" },
    { rx:/\bst\.?\s*lucie\s*west\b/i, norm:"St Lucie West" },
    { rx:/\bfort\s*pierce\b/i, norm:"Fort Pierce" },
    { rx:/\bport\s*charlotte\b/i, norm:"Port Charlotte" },
    { rx:/\bvero\s*beach\b/i, norm:"Vero Beach" },
    { rx:/\bjupiter\b/i, norm:"Jupiter" },
    { rx:/\bpalm\s*beach\s*gardens\b/i, norm:"Palm Beach Gardens" },
    { rx:/\bpalm\s*city\b/i, norm:"Palm City" },
    { rx:/\bstuart\b/i, norm:"Stuart" },
    { rx:/\bmiami\b/i, norm:"Miami" },
    { rx:/\borlando\b/i, norm:"Orlando" },
    { rx:/\btampa\b/i, norm:"Tampa" }
  ];

  // ===== Parser =====
  function parseQuery(q){
    const s = q.trim();
    const l = s.toLowerCase();
    const out = {
      location:"", minBeds:null, minBaths:null,
      priceMin:null, priceMax:null,
      homeSizeMin:null, homeSizeMax:null,
      lotSizeMin:null, lotSizeMax:null,
      yearBuiltMin:null, yearBuiltMax:null,
      keywords:[], subtype: detectSubtype(l)
    };

    // Location
    const inMatch = l.match(/\bin\s+([a-z\s\-\.']+(?:,\s*[a-z]{2})?)/i);
    if(inMatch) out.location = inMatch[1].trim();

    if(!out.location){
      const head = l.split(/(\d|under|over|less|more|bed|bath|pool|garage|fence|school|sq|acre|built|year|hot\s*tub|spa|jacuzzi)/i)[0].trim();
      if(head && head.length>2) out.location = head.replace(/[,\.]$/,'').trim();
    }

    if (!out.location) {
      for (const hint of CITY_HINTS) {
        const m = l.match(hint.rx);
        if (m) { out.location = hint.norm; break; }
      }
    }

    // Price
    const under = l.match(/\b(?:under|less\s+than)\s*\$?\s*([\d,\.kmb]+)/i);
    const over  = l.match(/\b(?:over|more\s+than|above)\s*\$?\s*([\d,\.kmb]+)/i);
    const range = l.match(/\$?\s*([\d,\.kmb]+)\s*[-–to]+\s*\$?\s*([\d,\.kmb]+)/i);
    if(range){ out.priceMin = normalizeMoney(range[1]); out.priceMax = normalizeMoney(range[2]); }
    else if(under){ out.priceMax = normalizeMoney(under[1]); }
    else if(over){ out.priceMin = normalizeMoney(over[1]); }

    // Beds / Baths
    const bed = l.match(/(\d+)\s*(?:\+?\s*)?(?:bed|bd|bedroom)s?/i);
    const bath = l.match(/(\d+(?:\.\d)?)\s*(?:\+?\s*)?(?:bath|ba|bathroom)s?/i);
    if(bed) out.minBeds = Number(bed[1]);
    if(bath) out.minBaths = Number(bath[1]);

    // Home size (sqft)
    const sqftPlus = l.match(/(\d{3,6})\s*(?:\+|\s*plus)?\s*(?:sq\.?\s*ft|square\s*feet|sqft)/i);
    const sqftRange = l.match(/(\d{3,6})\s*[-–to]+\s*(\d{3,6})\s*(?:sq\.?\s*ft|square\s*feet|sqft)/i);
    if(sqftRange){ out.homeSizeMin = sqftToNumber(sqftRange[1]); out.homeSizeMax = sqftToNumber(sqftRange[2]); }
    else if(sqftPlus){ out.homeSizeMin = sqftToNumber(sqftPlus[1]); }

    // Lot size (acres)
    const acrePlus = l.match(/(\d+(?:\.\d+)?)\s*(?:\+|\s*plus)?\s*(?:acre|acres)/i);
    const acreRange = l.match(/(\d+(?:\.\d+)?)\s*[-–to]+\s*(\d+(?:\.\d+)?)\s*(?:acre|acres)/i);
    if(acreRange){ out.lotSizeMin = acresToNumber(acreRange[1]); out.lotSizeMax = acresToNumber(acreRange[2]); }
    else if(acrePlus){ out.lotSizeMin = acresToNumber(acrePlus[1]); }

    // Year built
    const builtAfter = l.match(/\b(built|after|since)\s*(?:in\s*)?(\d{4})/i);
    const builtRange = l.match(/(19|20)\d{2}\s*[-–to]+\s*((?:19|20)\d{2})/i);
    const builtBefore = l.match(/\b(before|pre)\s*(\d{4})/i);
    if(builtRange){ const a = builtRange[0].match(/(19|20)\d{2}/)[0]; out.yearBuiltMin = Number(a); out.yearBuiltMax = Number(builtRange[2]); }
    else if(builtAfter){ out.yearBuiltMin = Number(builtAfter[2]); }
    else if(builtBefore){ out.yearBuiltMax = Number(builtBefore[2]); }

    // Features → keywords (normalised snake_case)
    for (const [label, rx] of Object.entries(FEATURE_RX)) {
      if (rx.test(l)) {
        const toks = FEATURE_TO_KEYWORDS[label] || [label];
        toks.forEach(t => out.keywords.push(normalizeKeywordToken(t)));
      }
    }
    out.keywords = Array.from(new Set(out.keywords)); // de-dup

    return out;
  }

  // ===== URL builder (KW expects min,max with "null" as open end) =====
  function setRange(params, name, min, max){
    const minStr = (min!=null ? String(min) : "");
    const maxStr = (max!=null ? String(max) : "null");
    if (minStr || maxStr !== "null") params.set(name, `${minStr},${maxStr}`);
  }
  function buildKwUrl(p){
    const u = new URL(KW.domain + KW.path);
    const params = u.searchParams;
    if(p.location) params.set("q", p.location);
    if(p.minBeds!=null) params.set("bedrooms", `${p.minBeds},null`);
    if(p.minBaths!=null) params.set("bathrooms", `${p.minBaths},null`);
    setRange(params, "price", p.priceMin, p.priceMax);
    setRange(params, "home_size", p.homeSizeMin, p.homeSizeMax);
    setRange(params, "lot_size", p.lotSizeMin, p.lotSizeMax);
    setRange(params, "year_built", p.yearBuiltMin, p.yearBuiltMax);
    params.set("property_subtype", p.subtype || "HOUSE");
    if(p.keywords?.length) params.set("keywords", p.keywords.join(","));
    return u.toString();
  }

  function buildSiteSearchUrl(parsed){
    const parts = [];
    if(parsed.location) parts.push(`"${parsed.location}"`);
    if(parsed.priceMax) parts.push(`"under $${parsed.priceMax.toLocaleString()}"`);
    if(parsed.priceMin) parts.push(`"over $${parsed.priceMin.toLocaleString()}"`);
    if(parsed.minBeds) parts.push(`"${parsed.minBeds} bed"`);
    if(parsed.minBaths) parts.push(`"${parsed.minBaths} bath"`);
    if(parsed.homeSizeMin) parts.push(`"${parsed.homeSizeMin}+ sqft"`);
    if(parsed.lotSizeMin) parts.push(`"${parsed.lotSizeMin}+ acres"`);
    if(parsed.yearBuiltMin) parts.push(`"built after ${parsed.yearBuiltMin}"`);
    if(parsed.yearBuiltMax) parts.push(`"built before ${parsed.yearBuiltMax}"`);
    (parsed.keywords||[]).forEach(k=>parts.push(`"${k}"`));
    return "https://www.google.com/search?q=" + encodeURIComponent(`site:homesforsaleflorida.kw.com ${parts.join(" ")}`);
  }

  function renderSummary(p, kwUrl, siteUrl){
    const rows = [
      ["Location", p.location || "—"],
      ["Beds (min)", p.minBeds ?? "—"],
      ["Baths (min)", p.minBaths ?? "—"],
      ["Price", `${p.priceMin?("$"+p.priceMin.toLocaleString()):""}${(p.priceMin||p.priceMax)?" – ":""}${p.priceMax?("$"+p.priceMax.toLocaleString()):"open"}`],
      ["Home Size (sqft)", `${p.homeSizeMin??"—"}${p.homeSizeMax?(" – "+p.homeSizeMax):""}`],
      ["Lot Size (acres)", `${p.lotSizeMin??"—"}${p.lotSizeMax?(" – "+p.lotSizeMax):""}`],
      ["Year Built", `${p.yearBuiltMin??"—"}${p.yearBuiltMax?(" – "+p.yearBuiltMax):""}`],
      ["Subtype", p.subtype],
      ["Keywords", p.keywords?.length ? p.keywords.join(", ") : "—"]
    ].map(([k,v])=>`<div class="kv"><span class="lab">${k}:</span>${v}</div>`).join("");
    elSummary.innerHTML = `
      <div class="card">
        <div class="kvgrid">${rows}</div>
        <div class="links">
          <a class="alink" href="${kwUrl}" target="_blank" rel="noopener">Open in New Tab</a>
          <a class="alink secondary" href="${siteUrl}" target="_blank" rel="noopener">Open Site Search</a>
        </div>
      </div>
    `;
  }

  // Try to load results in-frame; fall back if blocked
  function tryFrame(url){
    elFrameWrap.style.display = "block";
    elFrameNotice.style.display = "none";
    elFrame.src = "about:blank";

    let loaded = false;
    elFrame.onload = () => { loaded = true; };
    elFrame.src = url;

    setTimeout(() => {
      if (!loaded) {
        elFrameWrap.style.display = "none";
        elFrameNotice.style.display = "block";
      }
    }, 2500);
  }

  function act(openOnly=false){
    const q = elQ.value.trim();
    if(!q) return;
    elStatus.textContent = "Parsing…";
    const parsed = parseQuery(q);
    const kwUrl = buildKwUrl(parsed);
    const siteUrl = buildSiteSearchUrl(parsed);
    renderSummary(parsed, kwUrl, siteUrl);
    elStatus.textContent = "Ready";

    if (openOnly) {
      window.open(kwUrl, "_blank", "noopener");
      return;
    }
    tryFrame(kwUrl);
  }

  elGo.addEventListener('click', ()=>act(false));
  elOpen.addEventListener('click', ()=>act(true));
})();
</script>
</body>
</html>
